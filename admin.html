<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير - مركز تقني المحركات</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root {
            --primary: #004d40;
            --secondary: #ffb300;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #d32f2f;
            --success: #388e3c;
            --info: #0288d1;
        }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
        body{background:#f5f5f5;color:var(--dark);line-height:1.6}
        .container{max-width:1400px;margin:0 auto;padding:20px}
        header{background:var(--primary);color:white;padding:1rem 0;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:20px}
        .header-content{display:flex;justify-content:space-between;align-items:center}
        .logo h1{font-size:1.8rem}
        .nav-buttons button{background:var(--danger);color:white;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;font-size:.9rem;font-weight:600;transition:all .3s}
        .nav-buttons button:hover{background:#b71c1c}
        
        /* Dashboard Grid Layout */
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));gap:25px}
        
        .panel{background:white;padding:25px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05); position: relative;}
        .panel h2{color:var(--primary);border-bottom:2px solid var(--secondary);padding-bottom:10px;margin-bottom:20px; font-size: 1.3rem;}
        
        /* Technician List Styles */
        .tech-item {display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; transition: background 0.2s;}
        .tech-item:hover {background: #f9f9f9;}
        .tech-info strong {display: block; color: var(--primary);}
        .tech-info small {color: #666;}
        
        /* Booking Cards */
        .booking-card{background:var(--light);border-right:5px solid var(--info);padding:15px;border-radius:5px;margin-bottom:15px;cursor:pointer;transition:transform .2s, box-shadow .2s;}
        .booking-card:hover{transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
        .booking-card.selected{border-right-color:var(--secondary);background:#fffde7; border: 1px solid var(--secondary);}
        
        /* Forms & Buttons */
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:5px;font-weight:600}
        input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px}
        .btn{display: inline-block; background:var(--info);color:white;padding:10px 15px;border:none;border-radius:5px;cursor:pointer;font-weight:600;}
        .btn-success{background:var(--success)}
        .btn-danger{background:var(--danger)}
        .btn-block{width: 100%; text-align: center;}

        /* Modals */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:1000;justify-content:center;align-items:center}
        .modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:500px;position:relative; max-height: 90vh; overflow-y: auto;}
        .close-modal {position: absolute; left: 20px; top: 20px; font-size: 1.5rem; cursor: pointer; color: #666;}
        
        .alert-approval{background:#fff3e0; border-right-color: var(--danger);}
    </style>
</head>
<body>

<header>
    <div class="container header-content">
        <div class="logo"><h1><i class="fas fa-cogs"></i> لوحة تحكم المدير</h1></div>
        <div class="nav-buttons">
            <button id="logoutButton"><i class="fas fa-sign-out-alt"></i> خروج</button>
        </div>
    </div>
</header>

<div class="modal" id="loginModal" style="display: flex;">
    <div class="modal-content">
        <h3>تسجيل دخول المدير</h3>
        <form id="loginForm">
            <div class="form-group">
                <label>البريد الإلكتروني</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label>كلمة السر</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-block">دخول</button>
        </form>
    </div>
</div>

<div class="container" id="mainContent" style="display:none">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <p id="welcomeMessage" style="font-size:1.2rem; font-weight: bold;"></p>
        <span style="background: #e0f2f1; color: var(--primary); padding: 5px 10px; border-radius: 20px; font-size: 0.9rem;">
            <i class="fas fa-circle" style="color: var(--success); font-size: 0.6rem;"></i> النظام متصل
        </span>
    </div>

    <div class="dashboard-grid">
        
        <div class="panel">
            <h2><i class="fas fa-users-cog"></i> إدارة الفنيين</h2>
            <button class="btn btn-info btn-block" onclick="openModal('addTechModal')" style="margin-bottom: 15px;">
                <i class="fas fa-plus"></i> إضافة فني جديد
            </button>
            <div id="techniciansList" style="max-height: 300px; overflow-y: auto;">
                <p style="text-align: center; color: #666;">جاري تحميل الفنيين...</p>
            </div>
        </div>

        <div class="panel">
            <h2><i class="fas fa-calendar-check"></i> الحجوزات الجديدة (بانتظار التعيين)</h2>
            <div id="pendingBookingsList" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center;">جاري التحميل...</p>
            </div>
        </div>

        <div class="panel" id="assignmentPanel">
            <h2><i class="fas fa-user-tag"></i> تفاصيل المهمة والتعيين</h2>
            <div id="selectedBookingDetails" style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 15px; min-height: 100px;">
                <p style="color:#777; text-align: center; margin-top: 30px;">اختر حجزاً من القائمة لعرض التفاصيل.</p>
            </div>
            
            <form id="assignmentForm" style="display:none">
                <input type="hidden" id="bookingIdToAssign">
                <div class="form-group">
                    <label>اختيار الفني</label>
                    <select id="technicianSelect" required>
                        <option value="">-- اختر الفني --</option>
                        </select>
                </div>
                <div class="form-group">
                    <label>رقم كرت العمل (Job Card)</label>
                    <input type="text" id="workCardNumber" required placeholder="مثال: A-2024-001">
                </div>
                <button type="submit" class="btn btn-success btn-block"><i class="fas fa-check-circle"></i> تعيين المهمة</button>
            </form>
        </div>

        <div class="panel">
            <h2><i class="fas fa-exclamation-triangle"></i> طلبات الموافقة (من الفنيين)</h2>
            <div id="approvalRequestsList">
                <p style="text-align: center; color: #666;">لا توجد طلبات معلقة.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="addTechModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('addTechModal')">&times;</span>
        <h3>إضافة فني جديد</h3>
        <form id="addTechForm">
            <div class="form-group">
                <label>الاسم الكامل</label>
                <input type="text" id="techName" required placeholder="اسم الفني">
            </div>
            <div class="form-group">
                <label>رقم الجوال (سيستخدم للدخول)</label>
                <input type="tel" id="techPhone" required placeholder="05xxxxxxxx" pattern="05[0-9]{8}">
                <small style="color: #666; font-size: 0.8rem;">سيتم تحويله تلقائياً إلى اسم مستخدم للنظام.</small>
            </div>
            <div class="form-group">
                <label>كلمة المرور</label>
                <input type="text" id="techPass" required placeholder="******" minlength="6">
            </div>
            
            <div class="form-group">
                <label>التخصصات (تم التحديث بناءً على قائمة الخدمات)</label>
                <select id="techCapabilities" multiple style="height: 160px;">
                    <option value="ميكانيكا عامة">ميكانيكا عامة (إصلاح عام)</option>
                    <option value="كهرباء">كهرباء</option>
                    <option value="فحص كمبيوتر">فحص كمبيوتر</option>
                    
                    <option value="زيت وسيفون">زيت وسيفون</option>
                    <option value="غيار أقمشة">غيار أقمشة (فرامل)</option>
                    <option value="غيار زيت الجيربوكس">غيار زيت الجيربوكس</option>
                    <option value="تصفية محرك">تصفية محرك</option>
                    
                    <option value="فحص محرك">فحص محرك</option>
                    <option value="فحص أصوات">فحص أصوات</option>
                    <option value="أنظمة هيدروليك">أنظمة هيدروليك</option>
                    
                    <option value="سمكرة ودهان">سمكرة ودهان</option>
                    <option value="تكييف">تكييف</option>
                </select>
                <small style="color: var(--info);">اضغط Ctrl (أو Command) لتحديد أكثر من خيار</small>
            </div>
            <button type="submit" class="btn btn-success btn-block">إنشاء حساب الفني</button>
        </form>
    </div>
</div>

<div class="modal" id="reviewModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('reviewModal')">&times;</span>
        <h3>مراجعة طلب الأعمال الإضافية</h3>
        <div style="background: #ffebee; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <p><strong>العميل:</strong> <span id="reviewClientInfo"></span></p>
            <p><strong>سبب الطلب:</strong> <span id="reviewReason"></span></p>
        </div>
        <form id="reviewForm">
            <input type="hidden" id="approvalBookingId">
            <div class="form-group">
                <label>ملاحظات المدير والتكلفة للعميل</label>
                <textarea id="managerNotes" rows="4" required placeholder="اكتب هنا التكلفة المقدرة والقطع المطلوبة ليراها العميل..."></textarea>
            </div>
            <button type="submit" class="btn btn-success btn-block"><i class="fas fa-paper-plane"></i> إرسال للعميل للموافقة</button>
        </form>
    </div>
</div>

<script>
    // ========= Config =========
    const firebaseConfig = {
        apiKey: "AIzaSyAVweTlVbnd92xtTQcZwWo5sH7hiIDPlds",
        authDomain: "car-service-booking-edfda.firebaseapp.com",
        projectId: "car-service-booking-edfda",
        storageBucket: "car-service-booking-edfda.firebasestorage.app",
        messagingSenderId: "910485632535",
        appId: "1:910485632535:web:b16fc6f6ee94bb64da0e52",
        measurementId: "G-XHZVFM91HP"
    };

    // Initialize Main App
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Initialize Secondary App (For creating technicians without logging out)
    const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = secondaryApp.auth();

    // Collections
    const bookingsCollection = db.collection('bookings');
    const usersCollection = db.collection('users');
    const activityLogCollection = db.collection('activityLog');

    // ========= State =========
    let currentManagerId = null;

    // ========= UI Helpers =========
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    // ========= Auth Logic =========
    auth.onAuthStateChanged(async user => {
        if (user) {
            try {
                // Verify role in Firestore
                const doc = await usersCollection.doc(user.uid).get();
                if (doc.exists && doc.data().role === 'manager') {
                    currentManagerId = user.uid;
                    document.getElementById('welcomeMessage').textContent = `مرحباً، ${doc.data().name}`;
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('loginModal').style.display = 'none';
                    
                    // Load Data
                    loadTechniciansList();
                    fetchPendingBookings();
                    fetchApprovalRequests();
                    return;
                } else {
                    alert('هذا الحساب ليس لديه صلاحيات المدير.');
                    auth.signOut();
                }
            } catch (e) {
                console.error("Auth Check Error:", e);
            }
        }
        // Show login if not authenticated
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('loginModal').style.display = 'flex';
    });

    document.getElementById('loginForm').addEventListener('submit', async e => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            alert('خطأ في تسجيل الدخول: ' + error.message);
        }
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
        auth.signOut();
    });

    // ========= 1. Technician Management =========
    
    // Load Technicians
    function loadTechniciansList() {
        usersCollection.where('role', '==', 'technician').onSnapshot(snapshot => {
            const list = document.getElementById('techniciansList');
            const select = document.getElementById('technicianSelect');
            
            list.innerHTML = '';
            select.innerHTML = '<option value="">-- اختر الفني --</option>';

            if (snapshot.empty) {
                list.innerHTML = '<p style="text-align:center; padding:10px;">لا يوجد فنيين مسجلين.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const tech = doc.data();
                const caps = tech.capabilities ? tech.capabilities.join(', ') : 'عام';
                
                // Add to list
                const item = document.createElement('div');
                item.className = 'tech-item';
                item.innerHTML = `
                    <div class="tech-info">
                        <strong><i class="fas fa-user-wrench"></i> ${tech.name}</strong>
                        <small>${tech.phone} | ${caps}</small>
                    </div>
                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="deleteTechnician('${doc.id}')">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                `;
                list.appendChild(item);

                // Add to dropdown
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = `${tech.name} (${caps})`;
                select.appendChild(option);
            });
        });
    }

    // Add Technician (using Secondary App)
    document.getElementById('addTechForm').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true;
        btn.textContent = 'جاري الإنشاء...';

        const name = document.getElementById('techName').value;
        const phone = document.getElementById('techPhone').value;
        const pass = document.getElementById('techPass').value;
        const caps = Array.from(document.getElementById('techCapabilities').selectedOptions).map(o => o.value);
        
        // Create Proxy Email: 05xxxxxx@admintech.com
        const proxyEmail = `${phone.replace(/[^\d]/g, '')}@admintech.com`;

        try {
            // 1. Create in Auth
            const userCred = await secondaryAuth.createUserWithEmailAndPassword(proxyEmail, pass);
            
            // 2. Save to Firestore (users collection)
            await usersCollection.doc(userCred.user.uid).set({
                name: name,
                phone: phone,
                email: proxyEmail,
                role: 'technician',
                capabilities: caps,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'active'
            });

            // 3. Sign out secondary
            await secondaryAuth.signOut();

            alert('تم إضافة الفني بنجاح!');
            closeModal('addTechModal');
            document.getElementById('addTechForm').reset();
        } catch (error) {
            alert('خطأ: ' + error.message);
            console.error(error);
        } finally {
            btn.disabled = false;
            btn.textContent = 'إنشاء حساب الفني';
        }
    });

    // Delete Technician
    window.deleteTechnician = async (id) => {
        if(!confirm('هل أنت متأكد؟ سيمنع هذا الفني من الدخول للنظام.')) return;
        try {
            await usersCollection.doc(id).delete();
            alert('تم حذف سجل الفني.');
        } catch(e) {
            alert('خطأ: ' + e.message);
        }
    };

    // ========= 2. Pending Bookings & Assignment =========
    
    function fetchPendingBookings() {
        bookingsCollection
            .where('status', 'in', ['Received', 'Confirmed']) // Fetch both new and confirmed but not assigned
            .orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
                const list = document.getElementById('pendingBookingsList');
                list.innerHTML = '';
                
                // Filter client-side for unassigned if needed, or rely on UI
                const unassigned = snapshot.docs.filter(doc => !doc.data().technician_id);

                if (unassigned.length === 0) {
                    list.innerHTML = '<p style="text-align:center; padding:10px;">لا توجد حجوزات جديدة.</p>';
                    return;
                }

                unassigned.forEach(doc => {
                    const b = doc.data();
                    const div = document.createElement('div');
                    div.className = 'booking-card';
                    div.dataset.id = doc.id;
                    div.innerHTML = `
                        <h4>${b.car_plate_data} <span style="float:left; font-size:0.8rem; color:#666">${b.date}</span></h4>
                        <p><strong>${b.service_type}</strong> | ${b.car_model}</p>
                        <p><small><i class="fas fa-user"></i> ${b.customer_name}</small></p>
                    `;
                    div.onclick = () => selectBooking(doc.id, b);
                    list.appendChild(div);
                });
            });
    }

    function selectBooking(id, data) {
        // Highlight selection
        document.querySelectorAll('.booking-card').forEach(c => c.classList.remove('selected'));
        document.querySelector(`.booking-card[data-id="${id}"]`).classList.add('selected');

        // Show details
        const detailsDiv = document.getElementById('selectedBookingDetails');
        detailsDiv.innerHTML = `
            <h3 style="color:var(--primary); margin-bottom:10px;">${data.car_plate_data}</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9rem;">
                <div><strong>العميل:</strong> ${data.customer_name}</div>
                <div><strong>الجوال:</strong> ${data.customer_phone}</div>
                <div><strong>السيارة:</strong> ${data.car_model}</div>
                <div><strong>الخدمة:</strong> ${data.service_type}</div>
                <div><strong>الوقت:</strong> ${data.time}</div>
                <div><strong>التاريخ:</strong> ${data.date}</div>
            </div>
            <p style="margin-top:10px; background:white; padding:5px; border:1px dashed #ccc;">
                <strong>ملاحظات العميل:</strong> ${data.notes || 'لا يوجد'}
            </p>
        `;

        // Show form
        document.getElementById('bookingIdToAssign').value = id;
        document.getElementById('assignmentForm').style.display = 'block';
    }

    document.getElementById('assignmentForm').addEventListener('submit', async e => {
        e.preventDefault();
        const bookingId = document.getElementById('bookingIdToAssign').value;
        const techSelect = document.getElementById('technicianSelect');
        const techId = techSelect.value;
        const techName = techSelect.options[techSelect.selectedIndex].text.split(' (')[0];
        const cardNum = document.getElementById('workCardNumber').value;

        if(!bookingId || !techId) return;

        try {
            await bookingsCollection.doc(bookingId).update({
                technician_id: techId,
                technician_name: techName,
                work_card_number: cardNum,
                status: 'In_Progress', // Move directly to In Progress or Confirmed
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Log
            await activityLogCollection.add({
                booking_id: bookingId,
                user_role: 'Manager',
                type: 'Assignment',
                message: `تم تعيين الفني ${techName} للمهمة (كرت: ${cardNum})`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('تم تعيين المهمة بنجاح!');
            document.getElementById('assignmentForm').reset();
            document.getElementById('assignmentForm').style.display = 'none';
            document.getElementById('selectedBookingDetails').innerHTML = '<p style="text-align:center; padding-top:20px;">اختر حجزاً جديداً.</p>';
            
        } catch (err) {
            alert('خطأ: ' + err.message);
        }
    });

    // ========= 3. Approvals Logic =========
    
    function fetchApprovalRequests() {
        bookingsCollection
            .where('approval_pending_manager', '==', true)
            .onSnapshot(snapshot => {
                const list = document.getElementById('approvalRequestsList');
                list.innerHTML = '';
                
                if (snapshot.empty) {
                    list.innerHTML = '<p style="text-align:center; padding:10px; color:#666">لا توجد طلبات معلقة.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const b = doc.data();
                    const div = document.createElement('div');
                    div.className = 'booking-card alert-approval';
                    div.innerHTML = `
                        <h4 style="color:var(--danger)"><i class="fas fa-bell"></i> طلب موافقة</h4>
                        <p><strong>${b.car_plate_data}</strong> - الفني: ${b.technician_name}</p>
                        <p>السبب: ${b.manager_approval_request_reason}</p>
                        <button class="btn btn-danger" style="width:100%; margin-top:10px;" 
                            onclick="openReview('${doc.id}', '${b.customer_name}', '${b.car_plate_data}', '${b.manager_approval_request_reason}')">
                            مراجعة الطلب
                        </button>
                    `;
                    list.appendChild(div);
                });
            });
    }

    window.openReview = (id, name, plate, reason) => {
        document.getElementById('approvalBookingId').value = id;
        document.getElementById('reviewClientInfo').textContent = `${name} (${plate})`;
        document.getElementById('reviewReason').textContent = reason;
        openModal('reviewModal');
    };

    document.getElementById('reviewForm').addEventListener('submit', async e => {
        e.preventDefault();
        const id = document.getElementById('approvalBookingId').value;
        const notes = document.getElementById('managerNotes').value;

        try {
            await bookingsCollection.doc(id).update({
                approval_pending_manager: false,
                is_alert_pending: true, // Show to customer
                status: 'Pending_Approval', // Customer status
                manager_approval_notes: notes
            });

            await activityLogCollection.add({
                booking_id: id,
                user_role: 'Manager',
                type: 'Customer_Alert_Sent',
                message: `المدير يطلب موافقة العميل: ${notes}`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('تم إرسال الطلب للعميل.');
            closeModal('reviewModal');
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });

</script>

</body>
</html>
