<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير - مركز تقني المحركات</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root {
            --primary: #004d40;
            --secondary: #ffb300;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #d32f2f;
            --success: #388e3c;
            --info: #0288d1;
        }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
        body{background:#f5f5f5;color:var(--dark);line-height:1.6}
        .container{max-width:1400px;margin:0 auto;padding:20px}
        header{background:var(--primary);color:white;padding:1rem 0;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:20px}
        .header-content{display:flex;justify-content:space-between;align-items:center}
        .logo h1{font-size:1.8rem}
        .nav-buttons button{background:var(--danger);color:white;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;font-size:.9rem;font-weight:600;transition:all .3s}
        .nav-buttons button:hover{background:#b71c1c}
        h2{color:var(--primary);border-bottom:3px solid var(--secondary);padding-bottom:10px;margin-top:30px;margin-bottom:20px}
        .dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px}
        .panel{background:white;padding:25px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .booking-card{background:var(--light);border-right:5px solid var(--info);padding:15px;border-radius:5px;margin-bottom:15px;cursor:pointer;transition:background .2s}
        .booking-card:hover{background:#eceff1}
        .booking-card h4{color:var(--primary);margin-bottom:5px;font-size:1.1rem}
        .booking-card p{font-size:.9rem;margin:0}
        .booking-card.selected{border-right-color:var(--secondary);background:#fffde7}
        .btn{background:var(--info);color:white;padding:10px 15px;border:none;border-radius:5px;cursor:pointer;font-weight:600;transition:opacity .3s}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .btn-success{background:var(--success)}
        .btn-danger{background:var(--danger)}
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:5px;font-weight:600}
        input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px}
        .alert-approval{border:2px solid var(--danger);padding:15px;margin-top:20px;border-radius:5px;background:#ffebee}
        .badge{padding:4px 8px;border-radius:4px;font-size:.8rem;font-weight:700;display:inline-block;margin-left:8px}
        .badge-pending{background:#ff9800;color:white}
        .badge-approval{background:var(--danger);color:white}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:1000;justify-content:center;align-items:center}
        .modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:500px;position:relative}
        .modal-content h3{color:var(--primary);margin-bottom:20px}
    </style>
</head>
<body>

<header>
    <div class="container header-content">
        <div class="logo"><h1>لوحة تحكم المدير</h1></div>
        <div class="nav-buttons">
            <button id="logoutButton"><i class="fas fa-sign-out-alt"></i> خروج</button>
        </div>
    </div>
</header>

<div class="container" id="mainContent" style="display:none">
    <p id="welcomeMessage" style="font-size:1.1rem;margin-bottom:20px"></p>

    <div class="dashboard-grid">
        <div class="panel">
            <h2><i class="fas fa-calendar-check"></i> الحجوزات القادمة (بانتظار التعيين)</h2>
            <div id="pendingBookingsList">
                <p>جاري تحميل الحجوزات...</p>
            </div>
        </div>

        <div class="panel" id="assignmentPanel">
            <h2><i class="fas fa-user-tag"></i> تعيين مهمة / تفاصيل الحجز</h2>
            <div id="selectedBookingDetails" style="min-height:200px">
                <p style="color:#777">يرجى اختيار حجز من القائمة لتعيين فني أو مراجعة التفاصيل.</p>
            </div>
            
            <form id="assignmentForm" style="display:none">
                <input type="hidden" id="bookingIdToAssign">
                <div class="form-group">
                    <label for="technicianSelect">اختيار الفني</label>
                    <select id="technicianSelect" required>
                        <option value="">اختر فني</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="workCardNumber">رقم كرت العمل</label>
                    <input type="text" id="workCardNumber" required placeholder="مثال: A-1025">
                </div>
                <button type="submit" class="btn btn-success"><i class="fas fa-check-circle"></i> تعيين المهمة وتأكيدها</button>
            </form>
        </div>
    </div>

    <div class="panel">
        <h2><i class="fas fa-exclamation-triangle"></i> طلبات موافقة الأعمال الإضافية (بانتظار المراجعة)</h2>
        <div id="approvalRequestsList">
            <p>لا توجد حاليًا طلبات موافقة من الفنيين.</p>
        </div>
    </div>
</div>

<div class="modal" id="loginModal">
    <div class="modal-content">
        <h3>تسجيل دخول المدير</h3>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">البريد الإلكتروني</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">كلمة السر</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn">دخول</button>
        </form>
    </div>
</div>

<div class="modal" id="reviewModal">
    <div class="modal-content">
        <h3>مراجعة طلب موافقة العميل</h3>
        <p><strong>تفاصيل العميل والسيارة:</strong> <span id="reviewClientInfo"></span></p>
        <p><strong>سبب الطلب من الفني:</strong> <span id="reviewReason"></span></p>

        <form id="reviewForm">
            <input type="hidden" id="approvalBookingId">
            <div class="form-group">
                <label for="managerNotes">ملاحظات المدير للعميل (التكلفة المقدرة/القطع المطلوبة)</label>
                <textarea id="managerNotes" rows="4" required placeholder="مثال: تم تقدير التكلفة الإضافية بـ 350 ريالاً. القطع المطلوبة هي بلف حرارة."></textarea>
            </div>
            <button type="submit" class="btn btn-success"><i class="fas fa-paper-plane"></i> إرسال للعميل للموافقة</button>
        </form>
    </div>
</div>

<script>
    // ========= إعدادات Firebase (يجب استبدالها بإعدادات مشروعك الحقيقية) =========
    const firebaseConfig = {
        apiKey: "AIzaSyAVweTlVbnd92xtTQcZwWo5sH7hiIDPlds",
        authDomain: "car-service-booking-edfda.firebaseapp.com",
        projectId: "car-service-booking-edfda",
        storageBucket: "car-service-booking-edfda.firebasestorage.app",
        messagingSenderId: "910485632535",
        appId: "1:910485632535:web:b16fc6f6ee94bb64da0e52",
        measurementId: "G-XHZVFM91HP"
    };
    
    // **مهم جدًا:** تحقق من أن هذه الكتلة تعمل. إذا ظهر خطأ هنا، فإن المشكلة في إعداداتك.
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.error("Firebase Initialization Error:", e);
        alert("خطأ في تهيئة Firebase. يرجى مراجعة بيانات firebaseConfig.");
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const bookingsCollection = db.collection('bookings');
    const usersCollection = db.collection('users');
    const activityLogCollection = db.collection('activityLog');
      const techniciansCollection = db.collection('technicians'); // المجموعة المضافة لإدارة الفنيين

    let currentManagerId = null;
    let availableTechnicians = [];

    // ========= وظائف الإشعارات والتبديل =========
    function showToast(message, type = 'success') {
        console.log(`[Toast ${type.toUpperCase()}]: ${message}`);
        alert(message);
    }

    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function hideModal(id) { document.getElementById(id).style.display = 'none'; }

    // ========= المصادقة والتحقق من الدور =========
    document.getElementById('logoutButton').addEventListener('click', () => {
        auth.signOut();
        window.location.reload();
    });

    auth.onAuthStateChanged(async user => {
        if (user) {
            currentManagerId = user.uid;
            try {
                // البحث في Firestore باستخدام UID (تأكد من وجود المستند والدور)
                const doc = await usersCollection.doc(user.uid).get();
                if (doc.exists && doc.data().role === 'manager') {
                    document.getElementById('welcomeMessage').textContent = `أهلاً بك، المدير ${doc.data().name || 'المسؤول'}`;
                    document.getElementById('mainContent').style.display = 'block';
                    hideModal('loginModal');
                    fetchTechnicians();
                    fetchPendingBookings();
                    fetchApprovalRequests();
                    return;
                }
            } catch (e) {
                console.error("Error fetching role or Firestore rules error:", e);
            }
            // إذا لم يكن مديرًا أو فشل الجلب
            auth.signOut();
        }
        document.getElementById('mainContent').style.display = 'none';
        showModal('loginModal');
    });

    // **مهم:** هذا هو الجزء المسؤول عن زر "دخول".
    document.getElementById('loginForm').addEventListener('submit', async e => {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
            // محاولة تسجيل الدخول عبر Firebase Auth
            await auth.signInWithEmailAndPassword(email, password);
            // إذا نجح هذا، سيقوم auth.onAuthStateChanged أعلاه بالباقي.
        } catch (error) {
            // رسالة الخطأ هنا تعني أن Firebase Auth لم تتمكن من مطابقة البيانات.
            showToast('خطأ في تسجيل الدخول: البريد أو كلمة السر غير صحيحة. (خطأ المصادقة)', 'error');
            console.error('Firebase Auth Error:', error.message);
        }
    });

    // ========= جلب بيانات الفنيين =========
    function fetchTechnicians() {
        usersCollection.where('role', '==', 'technician').onSnapshot(snapshot => {
            availableTechnicians = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const select = document.getElementById('technicianSelect');
            select.innerHTML = '<option value="">اختر فني</option>';
            availableTechnicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name;
                select.appendChild(option);
            });
        }, error => console.error("Error fetching technicians:", error));
    }

    // ========= جلب الحجوزات بانتظار التعيين =========
    function fetchPendingBookings() {
        bookingsCollection
            .where('status', 'in', ['Pending', 'Confirmed'])
            .where('technician_id', '==', null)
            .orderBy('date', 'asc')
            .orderBy('time', 'asc')
            .onSnapshot(snapshot => {
                const list = document.getElementById('pendingBookingsList');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<p>لا توجد حجوزات بانتظار التعيين حاليًا.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const booking = doc.data();
                    const card = document.createElement('div');
                    card.className = 'booking-card';
                    card.dataset.id = doc.id;
                    card.innerHTML = `
                        <h4>${booking.car_plate_data} - ${booking.car_model}</h4>
                        <p><strong>الخدمة:</strong> ${booking.service_type} | <strong>الموعد:</strong> ${booking.date} ${booking.time}</p>
                        <p><strong>العميل:</strong> ${booking.customer_name} | <strong>الجوال:</strong> ${booking.customer_phone}</p>
                    `;
                    card.addEventListener('click', () => selectBooking(doc.id, booking));
                    list.appendChild(card);
                });
            }, error => console.error("Error fetching pending bookings:", error));
    }

    // ========= اختيار حجز للتعيين =========
    function selectBooking(id, booking) {
        document.querySelectorAll('.booking-card').forEach(card => card.classList.remove('selected'));
        document.querySelector(`.booking-card[data-id="${id}"]`).classList.add('selected');

        document.getElementById('bookingIdToAssign').value = id;
        document.getElementById('assignmentForm').style.display = 'block';
        document.getElementById('selectedBookingDetails').innerHTML = `
            <p><strong>لوحة السيارة:</strong> ${booking.car_plate_data}</p>
            <p><strong>موديل السيارة:</strong> ${booking.car_model}</p>
            <p><strong>نوع الخدمة:</strong> ${booking.service_type}</p>
            <p><strong>ملاحظات العميل:</strong> ${booking.notes || 'لا يوجد'}</p>
            <hr>
        `;
    }

    // ========= إرسال التعيين وتأكيد الحجز =========
    document.getElementById('assignmentForm').addEventListener('submit', async e => {
        e.preventDefault();
        const bookingId = document.getElementById('bookingIdToAssign').value;
        const technicianId = document.getElementById('technicianSelect').value;
        const workCardNumber = document.getElementById('workCardNumber').value;
        const technicianName = document.getElementById('technicianSelect').options[document.getElementById('technicianSelect').selectedIndex].text;

        if (!technicianId || !workCardNumber) {
            showToast('يرجى اختيار فني وإدخال رقم كرت العمل.', 'error');
            return;
        }

        try {
            await bookingsCollection.doc(bookingId).update({
                technician_id: technicianId,
                technician_name: technicianName,
                work_card_number: workCardNumber,
                status: 'Confirmed'
            });

            await activityLogCollection.add({
                booking_id: bookingId,
                user_role: 'Manager',
                type: 'Assignment_Alert', 
                message: `تم تعيين مهمة صيانة سيارتك للفني **${technicianName}** برقم كرت العمل **${workCardNumber}**. يرجى تتبع التقدم.`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                customer_alert: true
            });

            showToast('تم تعيين المهمة بنجاح وتأكيد الحجز وإشعار العميل.', 'success');
            document.getElementById('assignmentForm').reset();
            document.getElementById('assignmentForm').style.display = 'none';
            document.getElementById('selectedBookingDetails').innerHTML = '<p style="color:#777">يرجى اختيار حجز من القائمة لتعيين فني أو مراجعة التفاصيل.</p>';
        } catch (error) {
            showToast('خطأ في تعيين المهمة: ' + error.message, 'error');
        }
    });

    // ========= جلب طلبات الموافقة بانتظار مراجعة المدير =========
    function fetchApprovalRequests() {
        bookingsCollection
            .where('approval_pending_manager', '==', true)
            .orderBy('createdAt', 'asc')
            .onSnapshot(snapshot => {
                const list = document.getElementById('approvalRequestsList');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<p>لا توجد حاليًا طلبات موافقة من الفنيين.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const booking = doc.data();
                    const card = document.createElement('div');
                    card.className = 'booking-card alert-approval';
                    card.dataset.id = doc.id;
                    card.innerHTML = `
                        <h4><i class="fas fa-exclamation-circle"></i> طلب موافقة على أعمال إضافية</h4>
                        <p><strong>لوحة:</strong> ${booking.car_plate_data} | <strong>الفني:</strong> ${booking.technician_name}</p>
                        <p><strong>الملاحظة الأولية:</strong> ${booking.manager_approval_request_reason || 'غير محدد'}</p>
                        <button class="btn btn-danger" onclick="openReviewModal('${doc.id}', '${booking.customer_name}', '${booking.car_plate_data}', '${booking.manager_approval_request_reason}')" style="margin-top:10px">
                            <i class="fas fa-edit"></i> مراجعة وإرسال للعميل
                        </button>
                    `;
                    list.appendChild(card);
                });
            }, error => console.error("Error fetching approval requests:", error));
    }

    // ========= فتح نافذة مراجعة طلب الموافقة =========
    function openReviewModal(bookingId, customerName, plateData, reason) {
        document.getElementById('approvalBookingId').value = bookingId;
        document.getElementById('reviewClientInfo').textContent = `${customerName} - ${plateData}`;
        document.getElementById('reviewReason').textContent = reason;
        document.getElementById('managerNotes').value = '';
        showModal('reviewModal');
    }

    // ========= إرسال المراجعة للعميل =========
    document.getElementById('reviewForm').addEventListener('submit', async e => {
        e.preventDefault();
        const bookingId = document.getElementById('approvalBookingId').value;
        const managerNotes = document.getElementById('managerNotes').value;

        try {
            await bookingsCollection.doc(bookingId).update({
                approval_pending_manager: false,
                is_alert_pending: true,
                manager_approval_notes: managerNotes,
                status: 'Pending_Approval'
            });

            await activityLogCollection.add({
                booking_id: bookingId,
                user_role: 'Manager',
                type: 'Customer_Alert_Sent',
                message: `تمت مراجعة طلب الأعمال الإضافية من المدير وإرسال ملاحظات التكلفة/القطع للعميل للموافقة: ${managerNotes}`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                customer_alert: true
            });

            showToast('تم إرسال ملاحظات المدير وطلب الموافقة للعميل بنجاح.', 'success');
            hideModal('reviewModal');
        } catch (error) {
            showToast('خطأ في إرسال الموافقة: ' + error.message, 'error');
        }
    });

</script>

</body>
</html>
