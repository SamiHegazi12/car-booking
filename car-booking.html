<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² ØªÙ‚Ù†ÙŠ Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª - Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        /* ========= Ù†ÙØ³ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) ========= */
        :root {
            --primary: #2c5aa0;
            --secondary: #f8a41c;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --footer-bg: #2d2d2d;
            --footer-text: #b0b0b0;
            --footer-heading: #ffffff;
        }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
        body{background:#f5f5f5;color:var(--dark);line-height:1.6}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        header{background:linear-gradient(135deg,var(--primary),#1e3a8a);color:white;padding:1rem 0;box-shadow:0 4px 6px rgba(0,0,0,.1);position:relative}
        .header-content{display:flex;justify-content:space-between;align-items:center}
        .logo{display:flex;align-items:center}
        .logo h1{font-size:1.8rem;margin-right:15px}
        .nav-buttons{display:flex;justify-content:space-between;align-items:center;gap:10px}
        .nav-buttons button{background:var(--secondary);color:white;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;font-size:.9rem;font-weight:600;transition:all .3s}
        .nav-buttons button:hover{background:#e69500}
        .notification-bell{position:relative;background:var(--secondary);color:white;border:none;padding:10px;border-radius:50%;cursor:pointer;font-size:1.1rem;transition:all .3s;width:45px;height:45px;display:flex;align-items:center;justify-content:center}
        .notification-bell:hover{background:#e69500;transform:scale(1.1)}
        .notification-badge{position:absolute;top:-2px;right:-2px;background:var(--danger);color:white;border-radius:50%;width:18px;height:18px;font-size:.65rem;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white}
        .hero{background:linear-gradient(rgba(0,0,0,.7),rgba(0,0,0,.7)),url('https://images.unsplash.com/photo-1621135802920-133df287f89c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') no-repeat center/cover;height:400px;display:flex;align-items:center;justify-content:center;text-align:center;color:white;position:relative}
        .hero-content{position:relative;z-index:1}
        .hero h2{font-size:2.5rem;margin-bottom:20px}
        .hero p{font-size:1.2rem;max-width:700px;margin:0 auto}
        .booking-section,.tracking-section,.services-section{background:white;padding:40px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);margin:40px 0}
        .tracking-section{display:none}
        .section-title{text-align:center;margin-bottom:30px;color:var(--primary);position:relative;padding-bottom:15px}
        .section-title::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:100px;height:3px;background:var(--secondary)}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600}
        input,select,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:5px;font-size:1rem}
        input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(44,90,160,.2)}
        .form-row{display:flex;gap:20px}
        .form-row .form-group{flex:1}
        .btn{display:inline-block;background:var(--primary);color:white;padding:12px 25px;border:none;border-radius:5px;cursor:pointer;font-size:1rem;font-weight:600;transition:all .3s}
        .btn:hover{background:#1e3a8a;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.1)}
        .btn-secondary{background:var(--secondary)}
        .btn-secondary:hover{background:#e69500}
        .btn-danger{background:var(--danger);color:white}
        .btn-danger:hover{background:#c82333}
        .btn-info{background:var(--info);color:white}
        .btn-info:hover{background:#138496}
        .work-hours{background:var(--light);padding:15px;border-radius:5px;margin:15px 0;text-align:center}
        .tracking-card{background:#f8f9fa;border-left:5px solid var(--primary);padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
        .tracking-card.complete{border-left-color:var(--success)}
        .tracking-card.paused{border-left-color:var(--warning)}
        .tracking-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px dashed #ddd}
        .tracking-header h3{color:var(--primary);font-size:1.5rem;display:flex;align-items:center;gap:10px}
        .status-badge{padding:5px 10px;border-radius:5px;font-weight:bold;color:white;font-size:.9rem}
        .status-badge.in_progress{background:var(--info)}
        .status-badge.received{background:var(--primary)}
        .status-badge.paused{background:var(--warning);color:var(--dark)}
        .status-badge.complete{background:var(--success)}
        .status-badge.pending_approval{background:var(--danger)}
        .progress-bar-container{background:#e9ecef;border-radius:5px;margin:15px 0;overflow:hidden}
        .progress-bar{height:25px;background:var(--success);text-align:center;line-height:25px;color:white;font-weight:bold;transition:width .5s ease-in-out;min-width:15px}
        .tracking-details p{margin-bottom:8px}
        .tracking-log{margin-top:20px;padding:15px;background:white;border:1px solid #eee;border-radius:5px;max-height:200px;overflow-y:auto}
        .log-item{border-right:3px solid #ddd;padding-right:10px;margin-bottom:10px;font-size:.9rem}
        .log-item.alert{border-right-color:var(--danger);font-weight:bold;color:var(--danger)}
        .log-item.info{border-right-color:var(--info)}
        .log-item.approval{border-right-color:var(--success);color:var(--success)}
        .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:30px}
        .service-card{background:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.05);overflow:hidden;border:1px solid #eee;transition:transform .3s}
        .service-card:hover{transform:translateY(-5px);box-shadow:0 6px 18px rgba(0,0,0,.1)}
        .service-icon{font-size:3rem;padding:20px 20px 0;text-align:right;color:var(--secondary)}
        .service-content{padding:20px}
        .service-content h3{color:var(--primary);margin-top:0;margin-bottom:10px;font-size:1.3rem;border-bottom:2px solid var(--secondary);padding-bottom:5px}
        .warranty-badge{display:inline-block;background:#f0f8ff;color:var(--dark);padding:5px 10px;border-radius:5px;font-size:.85rem;font-weight:500;margin-top:15px}
        .warranty-badge i{margin-left:5px;color:var(--success)}
        .warranty-badge[style*="background: var(--primary);"]{color:white !important}
        .warranty-badge[style*="background: var(--primary);"] i{color:white}
        footer{background:var(--footer-bg);color:var(--footer-text);padding:40px 0 10px;font-size:.95rem}
        .footer-content{display:flex;justify-content:space-between;gap:30px;padding-bottom:20px;border-bottom:1px solid #444}
        .footer-section{flex:1;min-width:250px}
        .footer-section h3{color:var(--footer-heading);margin-bottom:20px;font-size:1.3rem}
        .footer-section p,.footer-section a{color:var(--footer-text);text-decoration:none;margin-bottom:10px;display:block}
        .footer-section a:hover{color:var(--secondary);text-decoration:underline}
        .contact-info-footer i{margin-left:8px;color:var(--secondary)}
        .work-hours-footer{list-style:none}
        .work-hours-footer li{margin-bottom:10px}
        .footer-bottom{text-align:center;padding-top:20px;font-size:.8rem}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:2000;justify-content:center;align-items:center}
        .modal-content{background:white;padding:30px;border-radius:10px;max-width:450px;width:90%;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}
        .modal-content h3{color:var(--primary);margin-bottom:20px}
        .auth-switch{margin-top:15px;cursor:pointer;color:var(--primary);text-decoration:underline;font-size:.9rem}
        .auth-form{display:none}
        .auth-form.active{display:block}
        
        /* Toast Style is already perfect */
        .toast{display:none;position:fixed;bottom:20px;right:20px;background-color:var(--dark);color:white;padding:15px;border-radius:5px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:3000; direction: rtl;}
        .toast.success{background-color:var(--success)}
        .toast.error{background-color:var(--danger)}
        .toast.warning{background-color:var(--warning);color:var(--dark)}
        .toast.info{background-color:var(--info)}
        .saved-data-info{background:#e8f5e8;border:1px solid #4caf50;border-radius:5px;padding:10px;margin-bottom:15px;font-size:.9rem;color:#2e7d32}
        .saved-data-info i{margin-left:5px}
        @media(max-width:992px){.footer-content{flex-wrap:wrap}.footer-section{flex-basis:45%}}
        @media(max-width:768px){.header-content{flex-direction:column;text-align:center;gap:15px}.form-row{flex-direction:column;gap:0}.hero h2{font-size:2rem}.tracking-header{flex-direction:column;align-items:flex-start;gap:10px}.footer-content{flex-direction:column}}
    </style>
</head>
<body>

<header>
    <div class="container header-content">
        <div class="logo"><h1>Ù…Ø±ÙƒØ² ØªÙ‚Ù†ÙŠ Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª</h1></div>
        <div class="nav-buttons">
            <button id="authButton"><i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
            <button id="logoutButton" style="display:none;background:var(--danger)"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
            <button class="notification-bell" id="notificationBell" title="Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªØªØ¨Ø¹"><i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationBadge" style="display:none">0</span>
            </button>
        </div>
    </div>
</header>

<section class="hero">
    <div class="hero-content">
        <h2 id="heroTitle">Ø­Ø¬ÙˆØ²Ø§Øª ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
        <p id="heroSubtitle">Ø£Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ù„ØµÙŠØ§Ù†Ø© Ø³ÙŠØ§Ø±ØªÙƒ ÙÙŠ Ù…Ø±ÙƒØ² ØªÙ‚Ù†ÙŠ Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª Ø¨ØµÙ†Ø§Ø¹ÙŠØ© Ø£Ø¨Ù‡Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
    </div>
</section>

<div class="container">
    <section class="tracking-section" id="customerTrackingSection">
        <h2 class="section-title">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„</h2>
        <div id="trackingCardsContainer">
            <p style="text-align:center;color:#666">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø¬ÙˆØ²Ø§Øª Ù†Ø´Ø·Ø©.</p>
        </div>
    </section>

    <section class="booking-section" id="bookingSection">
        <h2 class="section-title">Ø£Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ø§Ù„Ø¢Ù†</h2>
        <div class="work-hours">
            <h3><i class="fas fa-clock"></i> Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</h3>
            <p>Ù…Ù† ÙŠÙˆÙ… <strong>Ø§Ù„Ø³Ø¨Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ù…ÙŠØ³</strong>ØŒ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© <strong>8:00 ØµØ¨Ø§Ø­Ø§Ù‹ Ø­ØªÙ‰ 1:00 Ø¸Ù‡Ø±Ø§Ù‹</strong>ØŒ ÙˆÙ…Ù† <strong>3:00 Ù…Ø³Ø§Ø¡Ù‹ Ø­ØªÙ‰ 7:00 Ù…Ø³Ø§Ø¡Ù‹</strong></p>
        </div>

        <form id="bookingForm">
            <div id="authMessage" class="work-hours" style="background:var(--warning);color:var(--dark);margin-bottom:20px">
                ÙŠØ±Ø¬Ù‰ <strong class="auth-switch" data-target="login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong> Ø£Ùˆ <strong class="auth-switch" data-target="register">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</strong> Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ø¬Ø².
            </div>

            <div id="savedDataMessage" class="saved-data-info" style="display:none">
                <i class="fas fa-info-circle"></i> ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±.
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø«Ù„Ø§Ø«ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø§Ù„Ù…Ø³Ø¬Ù„)</label>
                    <input type="tel" id="phone" required placeholder="05XXXXXXXX" pattern="05[0-9]{8}" disabled>
                    <small style="color:var(--danger)">Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù…Ø³Ø¬Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</small>
                </div>
            </div>

            <div class="form-group">
                <label for="carType">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                <select id="carType" required>
                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
                    <option value="sedan">Ø³ÙŠØ¯Ø§Ù†</option>
                    <option value="suv">Ø¯ÙØ¹ Ø±Ø¨Ø§Ø¹ÙŠ</option>
                    <option value="other">Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="carModel">Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                    <input type="text" id="carModel" required placeholder="Ù…Ø«Ø§Ù„: ÙƒØ§Ù…Ø±ÙŠ 2023">
                </div>
                <div class="form-group">
                    <label for="serviceType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                    <select id="serviceType" required>
                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
                        <option value="oil">Ø²ÙŠØª ÙˆØ³ÙŠÙÙˆÙ†</option>
                        <option value="fabric">ØºÙŠØ§Ø± Ø£Ù‚Ù…Ø´Ø©</option>
                        <option value="gearbox">ØºÙŠØ§Ø± Ø²ÙŠØª Ø§Ù„Ø¬ÙŠØ±Ø¨ÙˆÙƒØ³</option>
                        <option value="computer">ÙØ­Øµ ÙƒÙ…Ø¨ÙŠÙˆØªØ±</option>
                        <option value="electricity">ÙØ­Øµ ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                        <option value="engine_check">ÙØ­Øµ Ù…Ø­Ø±Ùƒ</option>
                        <option value="sounds">ÙØ­Øµ Ø£ØµÙˆØ§Øª</option>
                        <option value="hydraulic">Ø£Ù†Ø¸Ù…Ø© Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙŠÙƒ</option>
                        <option value="engine_filter">ØªØµÙÙŠØ© Ù…Ø­Ø±Ùƒ</option>
                        <option value="other_repair">Ø£Ø®Ø±Ù‰ / Ø¥ØµÙ„Ø§Ø­ Ø¹Ø§Ù…</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                <div style="display:flex;gap:15px;margin-bottom:10px;align-items:center">
                    <label style="display:flex;align-items:center;gap:5px">
                        <input type="radio" name="plateType" value="saudi" id="plateTypeSaudi" checked style="width:auto"> Ù„ÙˆØ­Ø© Ø³Ø¹ÙˆØ¯ÙŠØ©
                    </label>
                    <label style="display:flex;align-items:center;gap:5px">
                        <input type="radio" name="plateType" value="foreign" id="plateTypeForeign" style="width:auto"> Ù„ÙˆØ­Ø© Ø£Ø¬Ù†Ø¨ÙŠØ©
                    </label>
                </div>

                <div id="saudiPlateInputs">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ø­Ø±ÙˆÙ (3 Ø£Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠØ©)</label>
                            <div style="display:flex;gap:5px;justify-content:space-between">
                                <input type="text" id="plateLetter1" class="plate-letter-input" maxlength="1" required placeholder="Ø£" style="text-align: center; flex: 1;">
                                <input type="text" id="plateLetter2" class="plate-letter-input" maxlength="1" required placeholder="Ø¨" style="text-align: center; flex: 1;">
                                <input type="text" id="plateLetter3" class="plate-letter-input" maxlength="1" required placeholder="Ø¬" style="text-align: center; flex: 1;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="plateNumbers">Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (1 - 4 Ø£Ø±Ù‚Ø§Ù…)</label>
                            <input type="text" id="plateNumbers" pattern="[0-9]{1,4}" required placeholder="Ù…Ø«Ø§Ù„: 1234">
                        </div>
                    </div>
                </div>

                <div class="form-group" id="foreignPlateInput" style="display:none">
                    <label for="foreignPlate">Ø§Ø¯Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ© Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</label>
                    <input type="text" id="foreignPlate" required disabled placeholder="Ù…Ø«Ø§Ù„: Dubai 70000">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label for="time">ÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
                    <select id="time" required disabled>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="notes" rows="3" placeholder="Ø§Ø°ÙƒØ± Ù‡Ù†Ø§ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©."></textarea>
            </div>

            <button type="submit" class="btn" id="submitBookingBtn" disabled><i class="fas fa-calendar-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ</button>
        </form>

        <div id="bookingMessage" class="work-hours" style="display:none;margin-top:20px"></div>
    </section>

    <section class="services-section">
        <h2 class="section-title">Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²</h2>
        <div class="services-grid">
            <div class="service-card">
                <div class="service-icon">ğŸ› ï¸</div>
                <div class="service-content">
                    <h3>Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                    <p>ØµÙŠØ§Ù†Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø­Ø±ÙƒØ§Øª ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„ÙØ±Ø§Ù…Ù„ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙˆØºÙŠØ±Ù‡Ø§ Ù…Ù† Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ø§Ù„Ø¹Ø§Ù…Ø©.</p>
                    <div class="warranty-badge" style="background:var(--primary); color:#fff;">
                        <i class="fas fa-medal"></i> Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ù„Ø­Ù‚Ø§Øª ÙˆØ§Ù„ØªØ±ÙƒÙŠØ¨
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-icon">ğŸ¨</div>
                <div class="service-content">
                    <h3>Ø§Ù„Ø³Ù…ÙƒØ±Ø© ÙˆØ§Ù„Ø¯Ù‡Ø§Ù†</h3>
                    <p>Ø¥ØµÙ„Ø§Ø­ Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¯Ù‡Ø§Ù†Ù‡Ø§ Ø¨Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø© ÙˆØªÙ†Ø§Ø³Ù‚ Ù„Ù„Ø£Ù„ÙˆØ§Ù†.</p>
                    <div class="warranty-badge" style="background:var(--primary); color:#fff;">
                        <i class="fas fa-medal"></i> Ø¶Ù…Ø§Ù† Ø¯Ù‡Ø§Ù† 10 Ø³Ù†ÙˆØ§Øª
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-icon">ğŸ”¨</div>
                <div class="service-content">
                    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±Ø¯ (PDR)</h3>
                    <p>Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø¬Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ø³Ù…ÙƒØ±Ø© Ø£Ùˆ Ø§Ù„Ø¯Ù‡Ø§Ù†ØŒ Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø§Ø¡ Ø§Ù„Ù…ØµÙ†Ø¹.</p>
                    <div class="warranty-badge">
                        <i class="fas fa-check-circle"></i> Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©
                    </div>
                </div>
            </div>
            
            <div class="service-card">
                <div class="service-icon">âš¡</div>
                <div class="service-content">
                    <h3>ÙØ­Øµ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ù‡Ø§ÙŠØ¨Ø±Ø¯</h3>
                    <p>ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨Ø·Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ <strong>ØªØ´Ø®ÙŠØµ ÙˆØµÙŠØ§Ù†Ø© Ø£Ù†Ø¸Ù…Ø© Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‡Ø§ÙŠØ¨Ø±Ø¯</strong>.</p>
                    <div class="warranty-badge">
                        <i class="fas fa-check-circle"></i> Ø®Ø¯Ù…Ø© Ù…ØªØ®ØµØµØ©
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-icon">ğŸ’»</div>
                <div class="service-content">
                    <h3>ÙØ­Øµ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</h3>
                    <p>ØªØ´Ø®ÙŠØµ Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø¯Ø« Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.</p>
                    <div class="warranty-badge">
                        <i class="fas fa-check-circle"></i> Ø¯Ù‚Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-icon">ğŸ”¬</div>
                <div class="service-content">
                    <h3>ÙØ­Øµ Ø§Ù„Ù…Ø­Ø±Ùƒ</h3>
                    <p>ÙØ­Øµ Ø¯Ù‚ÙŠÙ‚ ÙˆØ´Ø§Ù…Ù„ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø±Ùƒ ÙˆÙƒÙØ§Ø¦ØªÙ‡ Ù„ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© Ø£Ùˆ Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©.</p>
                    <div class="warranty-badge">
                        <i class="fas fa-check-circle"></i> ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„
                    </div>
                </div>
            </div>
            
            <div class="service-card">
                <div class="service-icon">ğŸ”Š</div>
                <div class="service-content">
                    <h3>ÙØ­Øµ Ø§Ù„Ø£ØµÙˆØ§Øª</h3>
                    <p>ÙØ­Øµ ÙˆØªØ´Ø®ÙŠØµ Ø§Ù„Ø£ØµÙˆØ§Øª ØºÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø£Ø³ÙÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ¥ØµÙ„Ø§Ø­Ù‡Ø§.</p>
                    <div class="warranty-badge">
                        <i class="fas fa-check-circle"></i> Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø®ÙÙŠØ©
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-icon">âš™ï¸</div>
                <div class="service-content">
                    <h3>Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙŠÙƒ</h3>
                    <p>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø±Ù…Ø¬Ø© ÙˆÙˆØ²Ù† ÙˆØ¥ØµÙ„Ø§Ø­Ø§Øª Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙŠÙƒ Ø¨Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¹Ø§Ù„ÙŠØ©.</p>
                    <div class="warranty-badge">
                        <i class="fas fa-check-circle"></i> Ø®Ø¨Ø±Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙŠÙƒ
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-icon">ğŸ”¥</div>
                <div class="service-content">
                    <h3>ØªØµÙÙŠØ© Ø§Ù„Ù…Ø­Ø±Ùƒ</h3>
                    <p>ØªÙ†Ø¸ÙŠÙ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠØ© Ù„Ù„Ù…Ø­Ø±Ùƒ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙØ§Ø¡Ø© ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙˆÙ‚ÙˆØ¯.</p>
                    <div class="warranty-badge">
                        <i class="fas fa-check-circle"></i> ÙƒÙØ§Ø¡Ø© Ø£Ø¹Ù„Ù‰
                    </div>
                </div>
            </div>

        </div>
    </section>
</div>

<footer>
    <div class="container footer-content">
        <div class="footer-section">
            <h3>Ù…Ø±ÙƒØ² ØªÙ‚Ù†ÙŠ Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª</h3>
            <p>Ù…Ø±ÙƒØ² Ù…ØªØ®ØµØµ ÙÙŠ ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ø£Ø­Ø¯Ø« Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ø£ØµÙ„ÙŠØ©. Ù†Ø­Ù† Ù…Ù„ØªØ²Ù…ÙˆÙ† Ø¨Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø´ÙØ§ÙÙŠØ©.</p>
        </div>
        <div class="footer-section">
            <h3>Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
            <a href="#bookingSection">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</a>
            <a href="#customerTrackingSection">ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø¬Ø²</a>
            <a href=".services-section">Ø®Ø¯Ù…Ø§ØªÙ†Ø§</a>
            <a href="https://www.enginetechnician.net/" target="_blank">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</a>
        </div>
        <div class="footer-section">
            <h3>ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h3>
            <div class="contact-info-footer">
                <a href="https://maps.app.goo.gl/fXY9BfeKDcjuwzNHA" target="_blank"><i class="fas fa-map-marker-alt"></i> ØµÙ†Ø§Ø¹ÙŠØ© Ø£Ø¨Ù‡Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø´Ø§Ø±Ø¹ 3</a>
                <p><i class="fas fa-phone"></i> <a href="tel:+966530694999">+966 530694999</a></p>
                <p><i class="fab fa-whatsapp" style="color:#25D366;"></i> +966 530694999</p>
                <p><i class="fas fa-envelope"></i> <a href="mailto:mailus@enginetechnician.net">mailus@enginetechnician.net</a></p>
            </div>
        </div>
        <div class="footer-section">
            <h3>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</h3>
            <ul class="work-hours-footer">
                <li>Ø§Ù„Ø³Ø¨Øª - Ø§Ù„Ø®Ù…ÙŠØ³: 8:00 Øµ - 1:00 Ù…</li>
                <li>Ø§Ù„Ø³Ø¨Øª - Ø§Ù„Ø®Ù…ÙŠØ³: 3:00 Ù… - 7:00 Ù…</li>
                <li>Ø§Ù„Ø¬Ù…Ø¹Ø©: Ø¥Ø¬Ø§Ø²Ø©</li>
            </ul>
        </div>
    </div>
    <div class="footer-bottom">
        <p>Â© 2006 Ù…Ø±ÙƒØ² ØªÙ‚Ù†ÙŠ Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
    </div>
</footer>

<div id="customerAuthModal" class="modal">
    <div class="modal-content">
        <h3 id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>

        <form id="loginForm" class="auth-form active">
            <div class="form-group">
                <label for="loginPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input type="tel" id="loginPhone" required placeholder="05XXXXXXXX" pattern="05[0-9]{8}">
            </div>
            <div class="form-group">
                <label for="loginPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn">Ø¯Ø®ÙˆÙ„</button>
            <p class="auth-switch" data-target="register">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <strong>Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</strong></p>
            <p class="auth-switch" data-target="recover">Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</p>
        </form>

        <form id="registerForm" class="auth-form">
            <div class="form-group">
                <label for="registerName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <input type="text" id="registerName" required>
            </div>
            <div class="form-group">
                <label for="registerPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input type="tel" id="registerPhone" required placeholder="05XXXXXXXX" pattern="05[0-9]{8}">
            </div>
            <div class="form-group">
                <label for="registerPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                <input type="password" id="registerPassword" required>
            </div>
            <div class="form-group">
                <label for="securityQuestion">Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† (Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±)</label>
                <select id="securityQuestion" required>
                    <option value="">Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†</option>
                    <option value="birth_city">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯</option>
                    <option value="first_pet">Ø§Ø³Ù… Ø£ÙˆÙ„ Ø­ÙŠÙˆØ§Ù† Ø£Ù„ÙŠÙ</option>
                    <option value="mother_name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆØ³Ø· Ù„ÙˆØ§Ù„Ø¯ØªÙƒ</option>
                </select>
            </div>
            <div class="form-group">
                <label for="securityAnswer">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</label>
                <input type="text" id="securityAnswer" required placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ø§Ø¨ØªÙƒ">
            </div>
            <button type="submit" class="btn btn-secondary">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
            <p class="auth-switch" data-target="login">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <strong>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong></p>
        </form>

        <form id="recoverForm" class="auth-form">
            <div class="form-group">
                <label for="recoverPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„</label>
                <input type="tel" id="recoverPhone" required placeholder="05XXXXXXXX" pattern="05[0-9]{8}">
            </div>
            <div class="form-group" id="recoverQuestionGroup" style="display:none">
                <label id="recoverQuestionLabel" for="recoverAnswer">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†:</label>
                <input type="text" id="recoverAnswer" required disabled>
            </div>
            <div class="form-group" id="newPasswordGroup" style="display:none">
                <label for="newPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <input type="password" id="newPassword" required disabled>
            </div>
            <button type="button" class="btn" id="checkSecurityBtn">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</button>
            <button type="submit" class="btn btn-danger" id="resetPasswordBtn" style="display:none">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
            <p class="auth-switch" data-target="login">ØªØ°ÙƒØ±Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ <strong>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong></p>
        </form>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    // ========= Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =========
    const customerAuthModal = document.getElementById('customerAuthModal');
    const authButton = document.getElementById('authButton');
    const logoutButton = document.getElementById('logoutButton');
    const authTitle = document.getElementById('authTitle');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const recoverForm = document.getElementById('recoverForm');
    const bookingForm = document.getElementById('bookingForm');
    const dateInput = document.getElementById('date');
    const timeSelect = document.getElementById('time');
    const submitBookingBtn = document.getElementById('submitBookingBtn');
    const authMessage = document.getElementById('authMessage');
    const phoneInput = document.getElementById('phone');
    const savedDataMessage = document.getElementById('savedDataMessage');
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const plateLetter1 = document.getElementById('plateLetter1');
    const plateLetter2 = document.getElementById('plateLetter2');
    const plateLetter3 = document.getElementById('plateLetter3');
    const plateNumbers = document.getElementById('plateNumbers');
    const foreignPlate = document.getElementById('foreignPlate');
    const saudiPlateInputs = document.getElementById('saudiPlateInputs');
    const foreignPlateInput = document.getElementById('foreignPlateInput');
    const recoverQuestionGroup = document.getElementById('recoverQuestionGroup');
    const newPasswordGroup = document.getElementById('newPasswordGroup');
    const checkSecurityBtn = document.getElementById('checkSecurityBtn');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    const recoverPhoneInput = document.getElementById('recoverPhone');
    const customerTrackingSection = document.getElementById('customerTrackingSection');
    const trackingCardsContainer = document.getElementById('trackingCardsContainer');

    // === NEW: Alert Sound Object ===
    const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
    // Store previous statuses to detect changes
    let bookingStatusCache = {};

    let userIsAuthenticated = false;
    let currentUserId = null;
    let currentUserName = null;

    // ========= Firebase Config =========
    const firebaseConfig = {
        apiKey: "AIzaSyAVweTlVbnd92xtTQcZwWo5sH7hiIDPlds",
        authDomain: "car-service-booking-edfda.firebaseapp.com",
        projectId: "car-service-booking-edfda",
        storageBucket: "car-service-booking-edfda.firebasestorage.app",
        messagingSenderId: "910485632535",
        appId: "1:910485632535:web:b16fc6f6ee94bb64da0e52",
        measurementId: "G-XHZVFM91HP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const bookingsCollection = db.collection('bookings');
    const closedDatesCollection = db.collection('closedDates');
    const usersCollection = db.collection('users');
    const techniciansCollection = db.collection('technicians');
    const activityLogCollection = db.collection('activityLog');

    // ========= Ø¯Ø§Ù„Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Utility Functions) =========
    function phoneToProxyEmail(phone) {
        const sanitizedPhone = phone.replace(/[^\d+]/g, ''); 
        return `${sanitizedPhone}@clientdomain.com`; 
    }

    // ========= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Toast) =========
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 5000);
    }

    function translateStatus(status) {
        const map = {
            'Received': 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
            'In_Progress': 'Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„',
            'Paused': 'Ù…ØªÙˆÙ‚ÙØ© Ù…Ø¤Ù‚ØªØ§Ù‹',
            'Pending_Approval': 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚ØªÙƒ',
            'Complete': 'Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…',
            'Confirmed': 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ¹Ø¯'
        };
        return map[status] || status;
    }

    // ========= Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =========
    function switchAuthForm(target) {
        loginForm.classList.remove('active');
        registerForm.classList.remove('active');
        recoverForm.classList.remove('active');

        document.getElementById('recoverAnswer').value = '';
        document.getElementById('newPassword').value = '';
        recoverQuestionGroup.style.display = 'none';
        newPasswordGroup.style.display = 'none';
        resetPasswordBtn.style.display = 'none';
        checkSecurityBtn.style.display = 'block';
        document.getElementById('recoverAnswer').disabled = true;
        document.getElementById('newPassword').disabled = true;

        if (target === 'login') {
            authTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            loginForm.classList.add('active');
        } else if (target === 'register') {
            authTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
            registerForm.classList.add('active');
        } else if (target === 'recover') {
            authTitle.textContent = 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±';
            recoverForm.classList.add('active');
        }
    }

    document.querySelectorAll('.auth-switch').forEach(switcher => {
        switcher.addEventListener('click', (e) => {
            const target = e.target.getAttribute('data-target') || e.target.parentNode.getAttribute('data-target');
            if (target) {
                switchAuthForm(target);
            }
        });
    });

    authButton.addEventListener('click', () => {
        customerAuthModal.style.display = 'flex';
        switchAuthForm('login'); 
    });

    customerAuthModal.addEventListener('click', (e) => {
        if (e.target === customerAuthModal) {
            customerAuthModal.style.display = 'none';
        }
    });

    logoutButton.addEventListener('click', async () => {
        try {
            await auth.signOut();
            localStorage.removeItem('userLoggedIn');
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('currentUserName');
            localStorage.removeItem('userPhone');
            initAuthenticationState(false, null, null, null);
            showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.', 'info');
        } catch (error) {
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + error.message, 'error');
        }
    });

    // ========= Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ =========
    registerForm.addEventListener('submit', async e => {
        e.preventDefault();
        const name = document.getElementById('registerName').value;
        const phone = document.getElementById('registerPhone').value;
        const password = document.getElementById('registerPassword').value;
        const question = document.getElementById('securityQuestion').value;
        const answer = document.getElementById('securityAnswer').value;
        
        const userSnap = await usersCollection.where('phone', '==', phone).get();
        if (!userSnap.empty) {
            showToast('Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.', 'warning');
            return;
        }

        const proxyEmail = phoneToProxyEmail(phone);

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(proxyEmail, password);
            const user = userCredential.user;

            await usersCollection.doc(user.uid).set({
                name,
                phone,
                security_question: question,
                security_answer: answer.toLowerCase().trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await auth.signOut();
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.', 'success');
            switchAuthForm('login');

        } catch (error) {
            let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message;
            if (error.code === 'auth/weak-password') errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¶Ø¹ÙŠÙØ© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).';
            showToast(errorMessage, 'error');
        }
    });

    loginForm.addEventListener('submit', async e => {
        e.preventDefault();
        const phone = document.getElementById('loginPhone').value;
        const password = document.getElementById('loginPassword').value;
        const proxyEmail = phoneToProxyEmail(phone);

        try {
            const userCredential = await auth.signInWithEmailAndPassword(proxyEmail, password);
            const user = userCredential.user;
            const doc = await usersCollection.doc(user.uid).get();

            if (doc.exists) {
                const userData = doc.data();
                localStorage.setItem('userLoggedIn', 'true');
                localStorage.setItem('currentUserId', user.uid);
                localStorage.setItem('currentUserName', userData.name);
                localStorage.setItem('userPhone', userData.phone);
                
                customerAuthModal.style.display = 'none';
                initAuthenticationState(true, user.uid, userData.name, userData.phone);
                showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${userData.name}! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.`, 'success');
            } else {
                await auth.signOut();
                showToast('Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙÙ‚ÙˆØ¯Ø©.', 'error');
            }

        } catch (error) {
            showToast('Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
        }
    });
    
    checkSecurityBtn.addEventListener('click', async () => {
        const phone = recoverPhoneInput.value;
        if (!phone || phone.length < 9) {
            showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­.', 'warning');
            return;
        }

        try {
            const userSnap = await usersCollection.where('phone', '==', phone).get();
            if (userSnap.empty) {
                showToast('Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± Ù…Ø³Ø¬Ù„.', 'error');
                return;
            }

            const userData = userSnap.docs[0].data();
            const questionText = userData.security_question;
            const questionMap = {
                'birth_city': 'Ù…Ø§ Ù‡ÙŠ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯ØŸ',
                'first_pet': 'Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø£ÙˆÙ„ Ø­ÙŠÙˆØ§Ù† Ø£Ù„ÙŠÙØŸ',
                'mother_name': 'Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆØ³Ø· Ù„ÙˆØ§Ù„Ø¯ØªÙƒØŸ'
            };

            recoverForm.dataset.userId = userSnap.docs[0].id;
            recoverForm.dataset.securityAnswer = userData.security_answer.toLowerCase().trim();

            document.getElementById('recoverQuestionLabel').textContent = questionMap[questionText] || 'Ù…Ø§ Ù‡ÙŠ Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†ØŸ';
            document.getElementById('recoverAnswer').value = '';
            document.getElementById('recoverAnswer').disabled = false;
            recoverQuestionGroup.style.display = 'block';
            checkSecurityBtn.style.display = 'none';
            resetPasswordBtn.style.display = 'block';
            showToast('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.', 'info');

        } catch (error) {
            showToast('Ø®Ø·Ø£: ' + error.message, 'error');
        }
    });

    recoverForm.addEventListener('submit', async e => {
        e.preventDefault();
        const storedAnswer = recoverForm.dataset.securityAnswer;
        const providedAnswer = document.getElementById('recoverAnswer').value.toLowerCase().trim();
        const newPassword = document.getElementById('newPassword').value;

        if (providedAnswer !== storedAnswer) {
            showToast('Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
            return;
        }
        
        if (newPasswordGroup.style.display === 'none') {
             newPasswordGroup.style.display = 'block';
             document.getElementById('newPassword').disabled = false;
             showToast('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.', 'success');
             return;
        }

        if (newPassword.length < 6) {
             showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù‚ØµÙŠØ±Ø©.', 'warning');
             return;
        }

        try {
            const phone = recoverPhoneInput.value;
            const proxyEmail = phoneToProxyEmail(phone);
            await auth.sendPasswordResetEmail(proxyEmail);
            showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ (Ø±Ù‚Ù…Ùƒ).', 'info');
            switchAuthForm('login');
        } catch (error) {
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ' + error.message, 'error');
        }
    });

    // ========= Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª =========
    const WORK_HOURS = { morningStart: 8, morningEnd: 13, eveningStart: 15, eveningEnd: 19 };
    let closedDatesCache = [];
    let closedTimesCache = [];

    function initializeClosedDatesListener() {
        closedDatesCollection.onSnapshot(snapshot => {
            closedDatesCache = snapshot.docs.map(doc => doc.data().date);
            if (dateInput.value) dateInput.dispatchEvent(new Event('change'));
        });
    }

    dateInput.addEventListener('change', async () => {
        const selectedDate = dateInput.value;
        timeSelect.innerHTML = '<option value="">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...</option>';
        timeSelect.disabled = true;
        submitBookingBtn.disabled = true;

        if (!selectedDate) return;

        if (closedDatesCache.includes(selectedDate)) {
            timeSelect.innerHTML = '<option value="">Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…ØºÙ„Ù‚.</option>';
            showToast('Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…ØºÙ„Ù‚.', 'warning');
            return;
        }

        try {
            const snapshot = await bookingsCollection.where('date', '==', selectedDate).get();
            const bookedTimes = snapshot.docs.map(doc => doc.data().time);
            const timeCounts = bookedTimes.reduce((acc, time) => {
                acc[time] = (acc[time] || 0) + 1;
                return acc;
            }, {});

            const fullyBookedTimes = Object.keys(timeCounts).filter(time => timeCounts[time] >= 3);
            closedTimesCache = fullyBookedTimes;

            const availableTimes = [];
            const dayOfWeek = new Date(selectedDate).getDay();

            if (dayOfWeek === 5) { // Friday
                timeSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©.</option>';
                return;
            }

            const workPeriods = [
                { start: WORK_HOURS.morningStart, end: WORK_HOURS.morningEnd },
                { start: WORK_HOURS.eveningStart, end: WORK_HOURS.eveningEnd }
            ];

            workPeriods.forEach(period => {
                for (let hour = period.start; hour < period.end; hour++) {
                    let timeValue = `${hour.toString().padStart(2, '0')}:00`;
                    if (!fullyBookedTimes.includes(timeValue)) {
                        availableTimes.push({ value: timeValue, text: timeValue });
                    }
                }
            });

            timeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>';
            if (availableTimes.length > 0) {
                availableTimes.sort((a, b) => a.value.localeCompare(b.value));
                availableTimes.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time.value;
                    option.textContent = time.text;
                    timeSelect.appendChild(option);
                });
                timeSelect.disabled = false;
            } else {
                timeSelect.innerHTML = '<option value="">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ù…ØªÙ„Ø¦Ø©.</option>';
            }

        } catch (error) {
            timeSelect.innerHTML = '<option value="">Ø­Ø¯Ø« Ø®Ø·Ø£.</option>';
        }
    });
    
    timeSelect.addEventListener('change', () => {
        submitBookingBtn.disabled = !userIsAuthenticated || !timeSelect.value;
    });

    document.querySelectorAll('input[name="plateType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'saudi') {
                saudiPlateInputs.style.display = 'block';
                foreignPlateInput.style.display = 'none';
                plateLetter1.required = true;
                plateLetter2.required = true;
                plateLetter3.required = true;
                plateNumbers.required = true;
                foreignPlate.required = false;
                foreignPlate.disabled = true;
            } else {
                saudiPlateInputs.style.display = 'none';
                foreignPlateInput.style.display = 'block';
                plateLetter1.required = false;
                plateLetter2.required = false;
                plateLetter3.required = false;
                plateNumbers.required = false;
                foreignPlate.required = true;
                foreignPlate.disabled = false;
            }
        });
    });
    
    [plateLetter1, plateLetter2, plateLetter3].forEach((input, index, array) => {
        input.addEventListener('input', (e) => {
            const arabicRegex = /[\u0600-\u06FF]/;
            let value = e.target.value.toUpperCase().trim().slice(0, 1);
            if (value && !arabicRegex.test(value)) value = '';
            e.target.value = value;
            if (value && index < array.length - 1) array[index + 1].focus();
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value === '' && index > 0) array[index - 1].focus();
        });
    });

    bookingForm.addEventListener('submit', async e => {
        e.preventDefault();
        submitBookingBtn.disabled = true;
        
        if (!userIsAuthenticated) {
            showToast('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.', 'warning');
            submitBookingBtn.disabled = false;
            return;
        }

        let plateData;
        const plateType = document.querySelector('input[name="plateType"]:checked').value;

        if (plateType === 'saudi') {
            const letter1 = plateLetter1.value.toUpperCase().trim();
            const letter2 = plateLetter2.value.toUpperCase().trim();
            const letter3 = plateLetter3.value.toUpperCase().trim();
            const numbers = plateNumbers.value.trim();
            const letters = `${letter1}${letter2}${letter3}`;
            const formattedLetters = `${letter1} ${letter2} ${letter3}`; 

            const saudiPlateRegex = /^[Ø¡-ÙŠ]{3}$/;
            if (!saudiPlateRegex.test(letters) || numbers.length < 1 || numbers.length > 4) {
                showToast('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­.', 'error');
                submitBookingBtn.disabled = false;
                return;
            }
            plateData = { plate_type: 'Saudi', car_plate_data: `${formattedLetters} - ${numbers}` };
        } else {
            const foreignPlateValue = foreignPlate.value.trim();
            if (foreignPlateValue === "") {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©.', 'error');
                submitBookingBtn.disabled = false;
                return;
            }
            plateData = { plate_type: 'Foreign', car_plate_data: foreignPlateValue };
        }

        const bookingData = {
            customer_id: currentUserId,
            customer_name: currentUserName,
            customer_phone: phoneInput.value,
            car_type: document.getElementById('carType').value,
            car_model: document.getElementById('carModel').value,
            service_type: document.getElementById('serviceType').value,
            date: dateInput.value,
            time: timeSelect.value,
            notes: document.getElementById('notes').value,
            ...plateData,
            status: 'Received',
            technician_id: null,
            technician_name: null,
            progress_percentage: 0,
            estimated_completion_time: null,
            is_alert_pending: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await bookingsCollection.add(bookingData);
            showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            bookingForm.reset();
            timeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>';
            timeSelect.disabled = true;
            dateInput.dispatchEvent(new Event('change'));
            submitBookingBtn.disabled = true; 
            fetchCustomerBookings(currentUserId);
        } catch (error) {
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: ' + error.message, 'error');
            submitBookingBtn.disabled = false;
        }
    });


    // ========= ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Updated with Alert Sound) =========
    function fetchCustomerBookings(userId) {
        customerTrackingSection.style.display = 'block';
        trackingCardsContainer.innerHTML = '<p style="text-align:center;color:var(--info);"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
        let pendingAlertCount = 0;

        bookingsCollection
            .where('customer_id', '==', userId)
            .where('status', '!=', 'Delivered')
            .orderBy('createdAt', 'desc') 
            .onSnapshot(snapshot => {
                trackingCardsContainer.innerHTML = '';
                pendingAlertCount = 0;

                if (snapshot.empty) {
                    trackingCardsContainer.innerHTML = '<p style="text-align:center;color:#666">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø¬ÙˆØ²Ø§Øª Ù†Ø´Ø·Ø©.</p>';
                    document.getElementById('notificationBadge').style.display = 'none';
                    return;
                }

                snapshot.forEach(doc => {
                    const booking = doc.data();
                    const id = doc.id;
                    booking.id = id;

                    // === NEW LOGIC START: Check for Status Change ===
                    // If we have seen this booking before AND the status is different
                    if (bookingStatusCache[id] && bookingStatusCache[id] !== booking.status) {
                        // Play Sound
                        alertSound.play().catch(e => console.log("Sound blocked by browser until user interaction"));
                        // Show visual alert
                        showToast(`ğŸ”” ØªØ­Ø¯ÙŠØ«: Ø£ØµØ¨Ø­Øª Ø­Ø§Ù„Ø© Ø³ÙŠØ§Ø±ØªÙƒ "${translateStatus(booking.status)}"`, 'info');
                    }
                    // Update Cache
                    bookingStatusCache[id] = booking.status;
                    // === NEW LOGIC END ===

                    if (booking.is_alert_pending || booking.status === 'Pending_Approval') {
                        pendingAlertCount++;
                    }

                    const statusMap = {
                        'Received': { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', class: 'received' },
                        'In_Progress': { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„', class: 'in_progress' },
                        'Paused': { text: 'Ù…ØªÙˆÙ‚ÙØ© Ù…Ø¤Ù‚ØªØ§Ù‹', class: 'paused' },
                        'Pending_Approval': { text: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', class: 'pending_approval' },
                        'Complete': { text: 'Ø§Ù„Ø¹Ù…Ù„ Ø§ÙƒØªÙ…Ù„', class: 'complete' }
                    };

                    const status = booking.status || 'Received';
                    const statusInfo = statusMap[status] || statusMap['Received'];
                    const progress = booking.progress_percentage || 0;
                    const technicianName = booking.technician_name || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ø¹Ø¯';
                    const ect = booking.estimated_completion_time ? 
                                `<strong>Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</strong> ${booking.estimated_completion_time}` : 
                                `<strong>Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</strong> ÙŠØ­Ø¯Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹`;

                    let approvalButton = '';
                    if (status === 'Pending_Approval') {
                        approvalButton = `
                            <div style="margin-top:15px;padding-top:15px;border-top:1px dashed #eee;">
                                <p style="color:var(--danger);font-weight:bold;margin-bottom:10px;">
                                    <i class="fas fa-exclamation-triangle"></i> ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ø£Ø¹Ù…Ø§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚ØªÙƒ.
                                </p>
                                <p style="color:var(--dark);margin-bottom:10px;">
                                    <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²:</strong> ${booking.manager_approval_notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª.'}
                                </p>
                                <button class="btn btn-success" data-action="approve" data-booking-id="${id}" style="margin-left:10px;">
                                    <i class="fas fa-check-circle"></i> Ù…ÙˆØ§ÙÙ‚Ø©
                                </button>
                                <button class="btn btn-danger" data-action="reject" data-booking-id="${id}">
                                    <i class="fas fa-times-circle"></i> Ø±ÙØ¶
                                </button>
                            </div>
                        `;
                    }
                    
                    const cardHtml = document.createElement('div');
                    cardHtml.className = `tracking-card ${statusInfo.class}`;
                    cardHtml.innerHTML = `
                        <div class="tracking-header">
                            <h3><i class="fas fa-car"></i> Ù„ÙˆØ­Ø© ${booking.car_plate_data}</h3>
                            <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
                        </div>
                        <div class="tracking-details">
                            <p><strong>Ø§Ù„Ø®Ø¯Ù…Ø©:</strong> ${booking.service_type}</p>
                            <p><strong>Ø§Ù„ÙÙ†ÙŠ:</strong> ${technicianName}</p>
                            <p>${ect}</p>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width:${progress}%">${progress}% Ø¥Ù†Ø¬Ø§Ø²</div>
                            </div>
                            ${approvalButton}
                            <h4><i class="fas fa-comment-dots"></i> Ø³Ø¬Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„:</h4>
                            <div class="tracking-log" id="log-${booking.id}">...</div>
                        </div>
                    `;
                    trackingCardsContainer.appendChild(cardHtml);
                    fetchActivityLog(booking.id);
                });
                
                const notificationBadge = document.getElementById('notificationBadge');
                if (pendingAlertCount > 0) {
                    notificationBadge.textContent = pendingAlertCount;
                    notificationBadge.style.display = 'flex';
                } else {
                    notificationBadge.style.display = 'none';
                }

                document.querySelectorAll('[data-action="approve"]').forEach(btn => {
                    btn.addEventListener('click', handleCustomerApproval);
                });
                document.querySelectorAll('[data-action="reject"]').forEach(btn => {
                    btn.addEventListener('click', handleCustomerRejection);
                });

            }, error => {
                trackingCardsContainer.innerHTML = '<p style="text-align:center;color:var(--danger)">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.</p>';
            });
    }

    function fetchActivityLog(bookingId) {
        const logElement = document.getElementById(`log-${bookingId}`);
        activityLogCollection
            .where('booking_id', '==', bookingId)
            .orderBy('timestamp', 'desc')
            .limit(10)
            .get()
            .then(snapshot => {
                logElement.innerHTML = '';
                if (snapshot.empty) {
                    logElement.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const log = doc.data();
                    let typeClass = 'info';
                    let icon = 'ğŸ’¬';

                    if (log.type === 'Alert') { typeClass = 'alert'; icon = 'âš ï¸'; } 
                    else if (log.type === 'Completion') { typeClass = 'approval'; icon = 'âœ…'; } 
                    else if (log.type === 'Customer_Alert_Sent') { typeClass = 'alert'; icon = 'ğŸ””'; }

                    const timestamp = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString('ar-SA', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    }) : '';

                    const logItem = document.createElement('div');
                    logItem.className = `log-item ${typeClass}`;
                    logItem.innerHTML = `${icon} <strong>${timestamp}</strong>: ${log.message}`;
                    logElement.appendChild(logItem);
                });
            });
    }
    
    async function handleCustomerApproval(e) {
        const bookingId = e.target.dataset.bookingId;
        e.target.disabled = true;

        try {
            await bookingsCollection.doc(bookingId).update({
                status: 'In_Progress', 
                is_alert_pending: false, 
                progress_percentage: 1, 
                manager_approval_notes: firebase.firestore.FieldValue.delete() 
            });

            await activityLogCollection.add({
                booking_id: bookingId,
                user_role: 'Customer',
                type: 'Completion',
                message: `ÙˆØ§ÙÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©.`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            showToast('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
        } catch (error) {
            showToast('Ø®Ø·Ø£: ' + error.message, 'error');
            e.target.disabled = false;
        }
    }

    async function handleCustomerRejection(e) {
        const bookingId = e.target.dataset.bookingId;
        e.target.disabled = true;

        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©ØŸ')) {
            e.target.disabled = false;
            return;
        }

        try {
            await bookingsCollection.doc(bookingId).update({
                status: 'Paused',
                is_alert_pending: false,
                manager_approval_notes: 'Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±ÙØ¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©.',
            });

            await activityLogCollection.add({
                booking_id: bookingId,
                user_role: 'Customer',
                type: 'Alert',
                message: `Ø±ÙØ¶ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©.`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            showToast('ØªÙ… Ø§Ù„Ø±ÙØ¶.', 'warning');
        } catch (error) {
            showToast('Ø®Ø·Ø£: ' + error.message, 'error');
            e.target.disabled = false;
        }
    }

    async function loadSavedData(userId) {
        const nameInput = document.getElementById('name');
        try {
            const doc = await usersCollection.doc(userId).get();
            if (doc.exists) {
                const userData = doc.data();
                nameInput.value = userData.name || '';
                phoneInput.value = userData.phone || '';

                const lastBookingSnap = await bookingsCollection
                    .where('customer_id', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .limit(1)
                    .get();

                if (!lastBookingSnap.empty) {
                    const lastBooking = lastBookingSnap.docs[0].data();
                    document.getElementById('carType').value = lastBooking.car_type || '';
                    document.getElementById('carModel').value = lastBooking.car_model || '';
                    
                    if (lastBooking.plate_type === 'Foreign') {
                        document.getElementById('plateTypeForeign').checked = true;
                        document.getElementById('plateTypeForeign').dispatchEvent(new Event('change'));
                        foreignPlate.value = lastBooking.car_plate_data;
                    } else {
                        document.getElementById('plateTypeSaudi').checked = true;
                        document.getElementById('plateTypeSaudi').dispatchEvent(new Event('change'));
                        const [lettersPart, numbers] = lastBooking.car_plate_data.split(' - ');
                        const cleanLetters = lettersPart.replace(/\s/g, '');
                        if (cleanLetters.length >= 3) {
                            plateLetter1.value = cleanLetters[0];
                            plateLetter2.value = cleanLetters[1];
                            plateLetter3.value = cleanLetters[2];
                        }
                        plateNumbers.value = numbers.trim();
                    }
                    savedDataMessage.style.display = 'block';
                }
            }
        } catch (error) { console.error(error); }
    }

    function updateUIForAuthentication(loggedIn, name, phone) {
        if (loggedIn) {
            authButton.style.display = 'none';
            logoutButton.style.display = 'block';
            document.getElementById('heroTitle').textContent = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${name}`;
            document.getElementById('heroSubtitle').textContent = `ÙŠÙ…ÙƒÙ†Ùƒ ØªØªØ¨Ø¹ Ø³ÙŠØ± Ø¹Ù…Ù„ Ø³ÙŠØ§Ø±ØªÙƒ Ø£Ùˆ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯.`;
            authMessage.style.display = 'none';
            phoneInput.value = phone || '';
            submitBookingBtn.disabled = !timeSelect.value;
            submitBookingBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²';
            customerTrackingSection.style.display = 'block';
            loadSavedData(currentUserId);
            fetchCustomerBookings(currentUserId);
        } else {
            authButton.style.display = 'block';
            logoutButton.style.display = 'none';
            document.getElementById('heroTitle').textContent = `Ø­Ø¬ÙˆØ²Ø§Øª ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª`;
            document.getElementById('heroSubtitle').textContent = `Ø£Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©`;
            authMessage.style.display = 'block';
            phoneInput.value = '';
            submitBookingBtn.disabled = true;
            submitBookingBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ';
            customerTrackingSection.style.display = 'none';
            savedDataMessage.style.display = 'none';
        }
    }

    function initAuthenticationState(loggedIn, id, name, phone) {
        userIsAuthenticated = loggedIn;
        currentUserId = id;
        currentUserName = name;
        updateUIForAuthentication(loggedIn, name, phone);
    }

    function init() {
        const today = new Date();
        today.setDate(today.getDate());
        dateInput.min = today.toISOString().split('T')[0];
        initializeClosedDatesListener();

        const loggedIn = localStorage.getItem('userLoggedIn') === 'true';
        const userId = localStorage.getItem('currentUserId');

        if (loggedIn && userId) {
            usersCollection.doc(userId).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    initAuthenticationState(true, userId, userData.name, userData.phone);
                } else {
                    localStorage.removeItem('userLoggedIn');
                    initAuthenticationState(false, null, null, null);
                }
            }).catch(error => {
                initAuthenticationState(false, null, null, null);
            });
        } else {
            initAuthenticationState(false, null, null, null);
        }
    }

    init();
</script>

</body>
</html>
