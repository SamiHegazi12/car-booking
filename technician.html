<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Tech - Technician Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <style>
        :root {
            --primary: #2c5aa0;
            --secondary: #f8a41c;
            --light: #f4f6f9;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --info: #17a2b8;
            --card-bg: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- Header & Nav --- */
        header {
            background: var(--dark);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.5rem;
            color: var(--secondary);
            margin: 0;
        }

        .nav-buttons button {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .nav-buttons button:hover {
            background: #c82333;
        }

        /* --- Dashboard Layout --- */
        #dashboard {
            display: none; /* Shown after login */
        }
        
        .welcome-bar {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .welcome-bar h2 {
            font-size: 1.8rem;
        }

        /* --- Task Cards Grid --- */
        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .task-card {
            background: var(--card-bg);
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        
        .task-card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .card-header h3 {
            color: var(--primary);
            font-size: 1.4rem;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            font-size: 0.8rem;
        }
        
        .status-pending { background: #6c757d; }
        .status-confirmed { background: var(--info); }
        .status-received { background: var(--primary); }
        .status-in_progress { background: var(--success); }
        .status-paused { background: var(--secondary); }
        .status-pending_approval { background: var(--danger); }
        .status-complete { background: #34495e; }
        .status-delivered { background: #00bcd4; }

        .card-body p {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .card-body strong {
            color: var(--primary);
            font-weight: 500;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 25px;
            background: var(--success);
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease-in-out;
            font-size: 0.85rem;
            min-width: 15px;
        }

        .card-actions {
            margin-top: 15px;
            text-align: right;
        }

        .card-actions button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .card-actions button:hover {
            background: #e69500;
            transform: translateY(-1px);
        }


        /* --- Login Modal --- */
        #loginModal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .modal-content .btn {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .modal-content .btn:hover {
            background: #1e3a8a;
        }
        
        /* --- Update Modal --- */
        #updateModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        #updateModal .modal-content {
            max-width: 500px;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }
        
        .modal-footer button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .modal-footer .btn-save {
            background: var(--success);
            color: white;
        }
        .modal-footer .btn-cancel {
            background: #ccc;
            color: var(--dark);
        }

        /* --- Toast Notification --- */
        #toast {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--dark);
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 4000;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <h1>ENGINE TECH</h1>
            </div>
            <div class="nav-buttons">
                <button id="logoutButton" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <div class="container" id="dashboard">
        <div class="welcome-bar">
            <h2 id="welcomeMessage">Welcome, Technician!</h2>
            <p>Your Assigned Tasks: <span id="taskCount">0</span></p>
        </div>

        <div class="task-grid" id="assignedTasksContainer">
            <p style="text-align: center; grid-column: 1 / -1; color: #666;">No active tasks assigned yet.</p>
        </div>
    </div>
    
    <div id="loginModal">
        <div class="modal-content">
            <h3>Technician Login</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginPhone">Phone Number</label>
                    <input type="tel" id="loginPhone" required placeholder="05XXXXXXXX" pattern="05[0-9]{8}">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            <p style="margin-top: 15px; font-size: 0.9rem; color: #777;">** Use the phone number and password provided by the Admin. **</p>
        </div>
    </div>

    <div id="updateModal">
        <div class="modal-content">
            <h3>Update Task Status</h3>
            <h4 id="updateCarPlate" style="color: var(--secondary); margin-bottom: 20px;"></h4>
            <form id="updateForm">
                <input type="hidden" id="bookingIdInput">

                <div class="form-group">
                    <label for="updateStatus">Current Status</label>
                    <select id="updateStatus" required>
                        <option value="Received">Received</option>
                        <option value="In_Progress">In Progress</option>
                        <option value="Paused">Paused</option>
                        <option value="Pending_Approval">Pending Customer Approval</option>
                        <option value="Complete">Complete (Ready for Delivery)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="updateProgress">Progress Percentage (%)</label>
                    <input type="range" id="updateProgress" min="0" max="100" step="5" value="0" oninput="document.getElementById('progressValue').innerText = this.value + '%'">
                    <p style="text-align: center; margin-top: 5px;">Value: <span id="progressValue">0%</span></p>
                </div>
                
                <div class="form-group">
                    <label for="updateECT">Estimated Completion Time (ECT)</label>
                    <input type="datetime-local" id="updateECT" required>
                </div>
                
                <div class="form-group">
                    <label for="updateNote">Note for Customer (Optional Alert)</label>
                    <textarea id="updateNote" rows="3" placeholder="Enter a note or an update that requires customer attention (e.g., needed extra part, approval required). This will trigger a notification."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="submit" class="btn-save"><i class="fas fa-save"></i> Save Updates</button>
                    <button type="button" class="btn-cancel" onclick="document.getElementById('updateModal').style.display='none'">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // 1. DOM Elements
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const dashboard = document.getElementById('dashboard');
        const logoutButton = document.getElementById('logoutButton');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const taskCountElement = document.getElementById('taskCount');
        const assignedTasksContainer = document.getElementById('assignedTasksContainer');
        const updateModal = document.getElementById('updateModal');
        const updateForm = document.getElementById('updateForm');
        const updateECTInput = document.getElementById('updateECT');
        const updateProgressRange = document.getElementById('updateProgress');

        // 2. State Variables
        let currentTechnicianId = null;
        let currentTechnicianName = null;
        let updateModalCurrentBookingId = null;

        // 3. Firebase Configuration
        // ***************************************************************
        // !! IMPORTANT: REPLACE with your actual Firebase config !!
        // ***************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyAVweTlVbnd92xtTQcZwWo5sH7hiIDPlds",
            authDomain: "car-service-booking-edfda.firebaseapp.com",
            projectId: "car-service-booking-edfda",
            storageBucket: "car-service-booking-edfda.firebasestorage.app",
            messagingSenderId: "910485632535",
            appId: "1:910485632535:web:b16fc6f6ee94bb64da0e52",
            measurementId: "G-XHZVFM91HP"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 4. Firestore Collections
        const bookingsCollection = db.collection('bookings');
        const techniciansCollection = db.collection('technicians');
        const activityLogCollection = db.collection('activityLog');

        // 5. Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        function formatPlate(data) {
             // Simple formatting logic for Arabic plate (e.g. A B C-1234)
            if (data.includes('-')) {
                return data.replace('-', ' ');
            }
            return data;
        }

        // 6. Authentication Logic
        
        // ** Simulated Technician Account Creation **
        async function ensureTechnicianAccount() {
            const phone = "0509999999"; // Default Technician Phone
            const name = "Khalid Alahmari"; // Default Technician Name
            const password = "techpassword"; // Default Technician Password
            
            const userSnap = await techniciansCollection.where('phone', '==', phone).get();
            
            if (userSnap.empty) {
                // Create a default technician if none exists
                const newTech = await techniciansCollection.add({
                    name: name,
                    phone: phone,
                    password: sha256(password), // Hash the password
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Default technician created for simulation:", newTech.id);
            }
        }
        
        // ** Login **
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const techSnap = await techniciansCollection.where('phone', '==', phone).get();
                
                if (techSnap.empty) {
                    showToast('Phone number not found in Technician records.', 'error');
                    return;
                }
                
                const techData = techSnap.docs[0].data();
                const techId = techSnap.docs[0].id;
                
                if (techData.password === sha256(password)) {
                    // Successful Login
                    currentTechnicianId = techId;
                    currentTechnicianName = techData.name;
                    localStorage.setItem('techLoggedIn', 'true');
                    localStorage.setItem('currentTechnicianId', techId);
                    localStorage.setItem('currentTechnicianName', techData.name);
                    
                    showDashboard();
                    showToast(`Welcome back, ${techData.name}!`, 'success');
                } else {
                    showToast('Incorrect password.', 'error');
                }
            } catch (error) {
                showToast('Login Error: ' + error.message, 'error');
                console.error(error);
            }
        });
        
        // ** Logout **
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('techLoggedIn');
            localStorage.removeItem('currentTechnicianId');
            localStorage.removeItem('currentTechnicianName');
            currentTechnicianId = null;
            currentTechnicianName = null;
            hideDashboard();
            showToast('Logged out successfully.', 'info');
        });
        
        // ** UI Toggles **
        function showDashboard() {
            loginModal.style.display = 'none';
            dashboard.style.display = 'block';
            logoutButton.style.display = 'block';
            welcomeMessage.textContent = `Welcome, ${currentTechnicianName}!`;
            fetchAssignedTasks(currentTechnicianId);
        }

        function hideDashboard() {
            loginModal.style.display = 'flex';
            dashboard.style.display = 'none';
            logoutButton.style.display = 'none';
        }

        // 7. Task Management Logic

        // ** Fetch Assigned Tasks (Real-time listener) **
        function fetchAssignedTasks(techId) {
            bookingsCollection
                .where('technician_id', '==', techId)
                // Filter out final state 'Delivered' (to focus on active work)
                .where('status', '!=', 'Delivered') 
                .orderBy('date', 'asc') // Show older bookings first
                .onSnapshot(snapshot => {
                    const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTasks(tasks);
                }, error => {
                    console.error("Error fetching assigned tasks: ", error);
                    assignedTasksContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: var(--danger);">Error loading tasks.</p>';
                });
        }
        
        // ** Render Task Cards **
        function renderTasks(tasks) {
            assignedTasksContainer.innerHTML = '';
            taskCountElement.textContent = tasks.length;

            if (tasks.length === 0) {
                 assignedTasksContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: #666;">No active tasks assigned yet. Check with the Admin.</p>';
                 return;
            }

            tasks.forEach(task => {
                const statusClass = `status-${task.status.toLowerCase().replace(/_/g, '')}`;
                const statusText = task.status.replace(/_/g, ' ');
                const progress = task.progress_percentage || 0;
                const ect = task.estimated_completion_time ? 
                            new Date(task.estimated_completion_time).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', day: 'numeric', month: 'short' }) : 
                            'N/A';

                const cardHtml = document.createElement('div');
                cardHtml.className = 'task-card';
                cardHtml.innerHTML = `
                    <div class="card-header">
                        <h3><i class="fas fa-car-side"></i> ${formatPlate(task.car_plate_data)}</h3>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Customer:</strong> ${task.customer_name}</p>
                        <p><strong>Phone:</strong> <a href="tel:${task.customer_phone}">${task.customer_phone}</a></p>
                        <p><strong>Service:</strong> ${task.service_type}</p>
                        <p><strong>Model:</strong> ${task.car_model}</p>
                        <p><strong>ECT:</strong> <span style="color: ${task.status === 'Complete' ? var(--success) : var(--info)}; font-weight: bold;">${ect}</span></p>
                        
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${progress}%; background: ${progress === 100 ? var(--success) : var(--primary)};">
                                ${progress}% Done
                            </div>
                        </div>
                        
                        <p style="font-style: italic; color: #777; margin-top: 10px;"><strong>Notes:</strong> ${task.notes || 'No notes.'}</p>
                    </div>
                    <div class="card-actions">
                        <button onclick="openUpdateModal('${task.id}', '${task.status}', ${progress}, '${task.estimated_completion_time || ''}')">
                            <i class="fas fa-edit"></i> Update Progress
                        </button>
                        ${task.is_alert_pending ? 
                            '<span style="color: var(--danger); font-weight: bold; margin-left: 10px;"><i class="fas fa-exclamation-triangle"></i> Customer Alert!</span>' : ''}
                    </div>
                `;
                
                assignedTasksContainer.appendChild(cardHtml);
            });
        }

        // ** Open Update Modal **
        window.openUpdateModal = function(bookingId, status, progress, ect) {
            updateModalCurrentBookingId = bookingId;
            document.getElementById('bookingIdInput').value = bookingId;
            document.getElementById('updateStatus').value = status.replace(/ /g, '_');
            updateProgressRange.value = progress;
            document.getElementById('progressValue').innerText = progress + '%';
            
            // Format ECT for datetime-local input
            let formattedECT = '';
            if (ect) {
                const date = new Date(ect);
                // Ensure correct local time formatting for input type="datetime-local"
                formattedECT = date.getFullYear() + '-' +
                                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                                String(date.getDate()).padStart(2, '0') + 'T' +
                                String(date.getHours()).padStart(2, '0') + ':' +
                                String(date.getMinutes()).padStart(2, '0');
            }
            updateECTInput.value = formattedECT;
            
            // Set car plate title (get from task object if possible, or show ID)
            const carPlate = assignedTasksContainer.querySelector(`[onclick*="${bookingId}"]`).closest('.task-card').querySelector('h3').textContent;
            document.getElementById('updateCarPlate').textContent = carPlate;

            updateModal.style.display = 'flex';
        }
        
        // ** Submit Update Form **
        updateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const bookingId = document.getElementById('bookingIdInput').value;
            const newStatus = document.getElementById('updateStatus').value;
            const newProgress = parseInt(updateProgressRange.value);
            const newECT = document.getElementById('updateECT').value;
            const customerNote = document.getElementById('updateNote').value;
            
            // Convert local datetime string to ISO string for storage
            const ectTimestamp = new Date(newECT).toISOString();

            try {
                const updateData = {
                    status: newStatus,
                    progress_percentage: newProgress,
                    estimated_completion_time: ectTimestamp,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                let logMessage = `Task updated by ${currentTechnicianName}: Status is now ${newStatus.replace(/_/g, ' ')}, ${newProgress}% done.`;
                let logType = 'Update';

                // Check for customer alert logic
                if (customerNote || newStatus === 'Pending_Approval') {
                    updateData.is_alert_pending = true; // Flag customer for action/review
                    logMessage = customerNote || `Customer approval is pending for new work/update.`;
                    logType = newStatus === 'Pending_Approval' ? 'Approval_Alert' : 'Info_Alert';
                } else {
                     updateData.is_alert_pending = false; // Clear alert if no specific note is left
                }

                // 1. Update Booking
                await bookingsCollection.doc(bookingId).update(updateData);
                
                // 2. Log Activity
                await activityLogCollection.add({
                    booking_id: bookingId,
                    user_role: 'Technician',
                    technician_id: currentTechnicianId,
                    type: logType,
                    message: logMessage,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('Task updated successfully!', 'success');
                updateModal.style.display = 'none';
                updateForm.reset();
            } catch (error) {
                showToast('Error updating task: ' + error.message, 'error');
                console.error(error);
            }
        });
        
        // Close modal when clicking outside
        updateModal.addEventListener('click', function(e) {
            if (e.target === updateModal) {
                updateModal.style.display = 'none';
            }
        });


        // 8. Initialization
        function init() {
            // Ensure a default technician account exists for easy testing
            ensureTechnicianAccount(); 
            
            // Check logged-in status
            const loggedIn = localStorage.getItem('techLoggedIn') === 'true';
            const techId = localStorage.getItem('currentTechnicianId');
            const techName = localStorage.getItem('currentTechnicianName');

            if (loggedIn && techId && techName) {
                currentTechnicianId = techId;
                currentTechnicianName = techName;
                showDashboard();
            } else {
                hideDashboard();
            }
        }

        init();
    </script>
</body>
</html>
